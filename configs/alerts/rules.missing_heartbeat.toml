# ------------------------------------------------------------
# ALERTING: ПРАВИЛА ТИПА missing_heartbeat
# Формат правил: [rule.<rule_name>] + вложенные секции
# Кратко:
# - Отслеживает отсутствие heartbeat-событий после первого принятого события.
# - Поднятие (firing): если heartbeat не приходил raise.missing_sec секунд.
# - Опускание (resolved): после подтвержденного восстановления heartbeat
#   (настройка resolve.hysteresis_sec).
# ------------------------------------------------------------

[rule.example_missing_heartbeat]
# Тип правила:
# - missing_heartbeat: взводит алерт при отсутствии heartbeat после первого события.
# Тип алгоритма: missing_heartbeat.
alert_type = "missing_heartbeat"

[rule.example_missing_heartbeat.match]
# Какие типы входящих событий считаем heartbeat-сигналом.
type = ["event", "agg"]
# Список var, которые считаются heartbeat для этого правила.
var = ["heartbeat"]
# Allow-only фильтр тегов.
tags = { dc = ["dc1"], service = ["api"] }

[rule.example_missing_heartbeat.match.value]
# Дополнительный фильтр по значению heartbeat.
# Обрабатываем только числовые heartbeat-события с value.n >= 1.
t = "n"
op = ">="
n = 1

[rule.example_missing_heartbeat.key]
# Список тегов, участвующих в построении детерминированного alert_id.
from_tags = ["dc", "service", "host"]

[rule.example_missing_heartbeat.raise]
# Взведение: если heartbeat не поступал missing_sec секунд -> firing.
# Если heartbeat не приходил missing_sec секунд -> firing.
missing_sec = 60

[rule.example_missing_heartbeat.resolve]
# Гистерезис восстановления heartbeat:
# - 0  => мгновенный resolved на первом heartbeat (legacy-поведение).
# - >0 => resolved только если heartbeat стабилен hysteresis_sec секунд.
hysteresis_sec = 30

[rule.example_missing_heartbeat.pending]
# Включает стадию pending перед firing.
enabled = false
# Сколько секунд условие должно удерживаться в pending до firing.
delay_sec = 300

# Окна без отправки уведомлений (локальная timezone хоста):
# В это время алерт продолжает вычисляться и логироваться, но уведомления не отправляются.
# [[rule.example_missing_heartbeat.notify.off]]
# days = ["mon", "tue", "wed", "thu", "fri"]
# from = "01:00"
# to = "06:00"

[[rule.example_missing_heartbeat.notify.route]]
# Канал доставки для уведомлений этого правила.
channel = "telegram"
# Имя шаблона в transport-конфиге канала.
template = "tg_default"
