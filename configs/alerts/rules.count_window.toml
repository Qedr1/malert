# ------------------------------------------------------------
# ALERTING: ПРАВИЛА ТИПА count_window
# Формат правил: [rule.<rule_name>] + вложенные секции
# Кратко:
# - Считает события в скользящем окне raise.tagg_sec секунд.
# - Поднятие (firing): когда сумма agg_cnt в окне >= raise.n.
# - Опускание (resolved): когда после последнего события тишина
#   длится не менее resolve.silence_sec секунд.
# ------------------------------------------------------------

[rule.cw_telegram_live]
# Тип правила:
# - count_window: считает события в скользящем окне времени.
# Тип алгоритма: count_window (скользящее окно).
alert_type = "count_window"

[rule.cw_telegram_live.match]
# Какие типы входящих событий учитывает правило.
type = ["event", "agg"]
# Список var, попадающих под это правило.
var = ["errors_window"]
# Allow-only фильтр тегов.
tags = { dc = ["dc1"], service = ["api"] }

[rule.cw_telegram_live.key]
# Список тегов, участвующих в построении детерминированного alert_id.
from_tags = ["dc", "service", "host"]

[rule.cw_telegram_live.raise]
# Порог взведения: firing если сумма agg_cnt в окне >= n.
# За последние tagg_sec секунд нужно >= n событий.
n = 10
# Размер скользящего окна для подсчета (сек).
tagg_sec = 60

[rule.cw_telegram_live.resolve]
# Порог гашения: если после последнего события тишина silence_sec секунд -> resolved.
# Гашение по тишине входящих событий.
silence_sec = 120
# Дополнительный гистерезис перед resolved (сек).
hysteresis_sec = 0

[rule.cw_telegram_live.pending]
# Включает стадию pending перед firing.
enabled = false
# Сколько секунд условие должно удерживаться в pending до firing.
delay_sec = 300

[[rule.cw_telegram_live.notify.route]]
# Канал доставки для уведомлений этого правила.
channel = "telegram"
# Имя шаблона в transport-конфиге канала.
template = "tg_default"
