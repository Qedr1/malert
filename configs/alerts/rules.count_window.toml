# ------------------------------------------------------------
# ALERTING: ПРАВИЛА ТИПА count_window
# Формат правил: [rule.<rule_name>] + вложенные секции
# Кратко:
# - Считает события в скользящем окне raise.window_sec секунд.
# - Поднятие (firing): когда сумма agg_cnt в окне >= raise.n.
# - Опускание (resolved): когда после последнего события тишина
#   длится не менее resolve.silence_sec секунд.
# ------------------------------------------------------------

[rule.example_count_window]
# Тип правила:
# - count_window: считает события в скользящем окне времени.
# Тип алгоритма: count_window (скользящее окно).
alert_type = "count_window"

[rule.example_count_window.match]
# Какие типы входящих событий учитывает правило.
type = ["event", "agg"]
# Список var, попадающих под это правило.
var = ["errors_window"]
# Allow-only фильтр тегов.
tags = { dc = ["dc1"], service = ["api"] }

[rule.example_count_window.match.value]
# Дополнительный фильтр по значению переменной.
# Для числового значения принимаем только value.n >= 1.
t = "n"
op = ">="
n = 1

[rule.example_count_window.key]
# Список тегов, участвующих в построении детерминированного alert_id.
from_tags = ["dc", "service", "host"]

[rule.example_count_window.raise]
# Порог взведения: firing если сумма agg_cnt в окне >= n.
# За последние window_sec секунд нужно >= n событий.
n = 10
# Размер скользящего окна для подсчета (сек).
window_sec = 60

[rule.example_count_window.resolve]
# Порог гашения: если после последнего события тишина silence_sec секунд -> resolved.
# Гашение по тишине входящих событий.
silence_sec = 120
# Дополнительный гистерезис перед resolved (сек).
hysteresis_sec = 0

[rule.example_count_window.pending]
# Включает стадию pending перед firing.
enabled = false
# Сколько секунд условие должно удерживаться в pending до firing.
delay_sec = 300

# Окна без отправки уведомлений (локальная timezone хоста):
# В это время алерт продолжает вычисляться и логироваться, но уведомления не отправляются.
# [[rule.example_count_window.notify.off]]
# days = ["sat", "sun"]
# from = "00:00"
# to = "24:00"

[[rule.example_count_window.notify.route]]
# Канал доставки для уведомлений этого правила.
channel = "telegram"
# Имя шаблона в transport-конфиге канала.
template = "tg_default"
