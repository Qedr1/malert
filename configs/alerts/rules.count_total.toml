# ------------------------------------------------------------
# ALERTING: ПРАВИЛА ТИПА count_total
# Формат правил: [rule.<rule_name>] + вложенные секции
# Кратко:
# - Считает суммарное число событий (agg_cnt) без временного окна.
# - Поднятие (firing): когда накопленный счетчик >= raise.n.
# - Опускание (resolved): когда новых событий нет resolve.silence_sec секунд.
# ------------------------------------------------------------

[rule.example_count_total]
# Тип правила:
# - count_total: суммирует количество входящих событий (agg_cnt) без окна.
# Тип алгоритма: накопительный count_total.
alert_type = "count_total"

[rule.example_count_total.match]
# Какие типы входящих событий учитывает правило.
# Принимаем только event для var=errors.
type = ["event"]
# Список var, попадающих под это правило.
var = ["errors"]
# Allow-only фильтр тегов.
# Для каждого указанного тега значение должно входить в allow-список.
tags = { dc = ["dc1"], service = ["api"] }

[rule.example_count_total.match.value]
# Дополнительный фильтр по значению переменной.
# t = "n" означает числовой value.n, op = ">=" c порогом n.
t = "n"
op = ">="
n = 1

[rule.example_count_total.key]
# Список тегов, участвующих в построении детерминированного alert_id.
# Участвует в построении alert_id.
from_tags = ["dc", "service", "host"]

[rule.example_count_total.raise]
# Порог взведения: firing при накопленном count >= n.
# Алерт взводится при первом событии.
n = 1

[rule.example_count_total.resolve]
# Порог гашения: если новых событий нет silence_sec секунд -> resolved.
# Гасим алерт после тишины 60 секунд.
silence_sec = 60
# Дополнительный гистерезис перед resolved (сек).
hysteresis_sec = 0

[rule.example_count_total.pending]
# Включает стадию pending перед firing.
# Без pending: сразу firing.
enabled = false
# Сколько секунд условие должно удерживаться в pending до firing.
delay_sec = 300

# Окна без отправки уведомлений (локальная timezone хоста):
# В это время алерт продолжает вычисляться и логироваться, но уведомления не отправляются.
# [[rule.example_count_total.notify.off]]
# days = ["mon", "tue", "wed", "thu", "fri"]
# from = "22:00"
# to = "08:00"

[[rule.example_count_total.notify.route]]
# Канал доставки для уведомлений этого правила.
channel = "telegram"
# Имя шаблона в transport-конфиге канала.
template = "tg_default"
